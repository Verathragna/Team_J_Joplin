
import { dirname } from 'path';
import { writeFile, readFile } from 'fs/promises';
const allCategories = require('@joplin/lib/pluginCategories.json');

const updateCategories = async () => {
	const buildScriptPath = `${dirname(__dirname)}/generators/app/templates/webpack.config.js`;
	const originalBuildScript = await readFile(buildScriptPath, 'utf8');

	const autoGeneratedStartString = '\n// Begin auto-generated';
	const autoGeneratedStart = originalBuildScript.indexOf(autoGeneratedStartString);
	const autoGeneratedEndString = '// End auto-generated\n';
	const autoGeneratedEnd = originalBuildScript.indexOf(autoGeneratedEndString);

	// Make the generated categories pass the linter
	const possibleCategoriesText = JSON.stringify(allCategories).replace(/["]/g, '\'');

	const buildScript = [
		originalBuildScript.substring(0, autoGeneratedStart + autoGeneratedStartString.length),
		`const allPossibleCategories = ${possibleCategoriesText};`,
		originalBuildScript.substring(autoGeneratedEnd),
	].join('\n');

	await writeFile(buildScriptPath, buildScript, 'utf8');
};

void updateCategories();
